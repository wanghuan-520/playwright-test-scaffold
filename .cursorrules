# ═══════════════════════════════════════════════════════════════
# Playwright Test Scaffold - Cursor Rules
# ═══════════════════════════════════════════════════════════════
# AI 驱动的自动化测试脚手架 - Cursor 对话时自动参考

## 项目定位

这是一个 **AI 驱动的 Playwright + Python 自动化测试脚手架**，通过自然语言对话生成：
- Page Object 页面对象
- Test Cases 测试用例
- Test Data 测试数据
- Allure Reports 测试报告

**使用方式：只通过 AI 对话交互，无需命令行。**

## ⚠️ 代码生成前必读（Critical）

**在生成任何 Page Object 或 Test Case 代码之前，必须执行以下步骤：**

```
必读文件（按顺序）：
1. config/project.yaml               → 项目配置（仓库/服务/数据）
2. generators/test_code_generator.py → 代码模板（怎么写）
3. utils/logger.py                   → Logger 使用方式
```

## ⭐ 页面功能分析流程（核心）

当用户说"测试 xxx 页面"时，**必须先分析页面功能点**：

### Step 1: 读取项目配置

```python
# 读取 config/project.yaml 获取仓库信息
repositories:
  frontend:
    url: "https://github.com/owner/frontend"
  backend:
    url: "https://github.com/owner/backend"
```

### Step 2: 根据页面 URL 推断代码位置

| 页面 URL | 可能的前端代码位置 |
|----------|-------------------|
| `/login` | `src/pages/login/`, `src/views/Login.tsx` |
| `/admin/profile` | `src/pages/admin/profile/`, `src/views/Profile/` |
| `/admin/profile/change-password` | `src/pages/admin/profile/ChangePassword.tsx` |
| `/orders` | `src/pages/orders/`, `src/views/Orders/` |
| `/products/:id` | `src/pages/products/[id].tsx`, `src/views/ProductDetail/` |

**常见前端项目结构：**
- React: `src/pages/`, `src/views/`, `src/components/`
- Vue: `src/views/`, `src/pages/`, `src/components/`
- Next.js: `pages/`, `app/`

### Step 3: 使用 DeepWiki MCP 查询代码

```
# 使用 mcp_deepwiki-sse_ask_question 工具查询

问题示例：
1. "这个项目的目录结构是什么？"
2. "找到 /admin/profile 页面对应的代码文件"
3. "ProfilePage 组件有哪些功能和状态？"
4. "修改密码功能的表单验证规则是什么？"
5. "这个页面调用了哪些 API 接口？"
```

### Step 4: 分析功能点

从代码中提取：

| 分析维度 | 关注点 |
|----------|--------|
| **表单字段** | 输入框、下拉框、复选框、必填/可选 |
| **验证规则** | 正则、长度限制、格式要求 |
| **API 接口** | 请求方法、参数、响应 |
| **状态管理** | 加载状态、错误状态、成功状态 |
| **用户交互** | 按钮、链接、弹窗、提示 |
| **业务逻辑** | 条件判断、流程分支 |

### Step 5: 生成测试用例

基于分析结果生成覆盖以下场景的测试：

| 优先级 | 测试类型 | 来源 |
|--------|----------|------|
| P0 | 核心功能测试 | 主要业务流程 |
| P0 | 必填字段验证 | 表单验证规则 |
| P1 | 边界值测试 | 长度限制、数值范围 |
| P1 | 格式验证测试 | 正则表达式规则 |
| P1 | API 错误处理 | 接口异常场景 |
| P2 | UI 状态测试 | 加载、禁用、高亮 |

### 示例：分析修改密码页面

```
用户: 帮我测试修改密码页面

AI 执行流程:
┌─────────────────────────────────────────────────────────────────┐
│ 1. 读取 config/project.yaml                                     │
│    → 获取 frontend 仓库: https://github.com/owner/frontend      │
├─────────────────────────────────────────────────────────────────┤
│ 2. 推断代码位置                                                  │
│    → URL: /admin/profile/change-password                        │
│    → 可能位置: src/pages/admin/profile/ChangePassword.tsx       │
├─────────────────────────────────────────────────────────────────┤
│ 3. DeepWiki 查询                                                │
│    Q1: "ChangePassword 组件的代码在哪里？"                       │
│    Q2: "修改密码表单有哪些字段和验证规则？"                        │
│    Q3: "修改密码调用的 API 接口是什么？"                          │
├─────────────────────────────────────────────────────────────────┤
│ 4. 分析功能点                                                   │
│    表单字段:                                                    │
│    - currentPassword (必填, 当前密码)                           │
│    - newPassword (必填, 8-20字符, 含大小写+数字)                 │
│    - confirmPassword (必填, 需与新密码一致)                      │
│                                                                 │
│    验证规则:                                                    │
│    - 新密码长度 8-20                                            │
│    - 必须包含大写、小写、数字                                    │
│    - 新密码不能与当前密码相同                                    │
│    - 确认密码必须匹配                                           │
│                                                                 │
│    API 接口:                                                    │
│    - POST /api/user/change-password                             │
│    - 参数: { currentPassword, newPassword }                     │
├─────────────────────────────────────────────────────────────────┤
│ 5. 生成测试用例                                                 │
│    P0: test_p0_page_load - 页面加载                             │
│    P0: test_p0_change_password_success - 正常修改密码            │
│    P0: test_p0_wrong_current_password - 当前密码错误             │
│    P1: test_p1_password_too_short - 密码太短                    │
│    P1: test_p1_password_mismatch - 确认密码不匹配                │
│    P1: test_p1_same_as_current - 新密码与当前相同                │
│    P2: test_p2_password_visibility - 密码显示/隐藏              │
└─────────────────────────────────────────────────────────────────┘
```

## 核心架构

```
playwright-test-scaffold/
├── config/
│   └── project.yaml      # 项目配置中心（仓库/服务/数据）
├── core/
│   ├── base_page.py      # 页面对象基类
│   ├── page_utils.py     # 页面工具类
│   └── fixtures.py       # pytest fixtures
├── generators/
│   ├── page_analyzer.py      # 页面分析器
│   └── test_code_generator.py # 测试代码生成
├── utils/
│   ├── config.py             # 配置管理器
│   ├── logger.py             # 日志系统
│   └── service_checker.py    # 服务健康检查
├── pages/          # Page Objects
├── tests/          # Test Cases
└── test-data/      # 测试数据
```

## AI 对话指令处理

### 测试页面（完整流程）
```
"帮我测试 xxx 页面"
"测试 /admin/profile/change-password"
```
→ 执行「页面功能分析流程」→ 生成测试代码

### 检查服务
```
"检查服务状态"
"服务是否启动"
```
→ 调用 ServiceChecker 检查

### 运行测试
```
"运行测试"
"执行 P0 测试"
```
→ 先检查服务 → 构建 pytest 命令

### 查看报告
```
"打开 Allure 报告"
```
→ 执行 allure serve allure-results

## 关键实现细节

```python
# ❌ 错误：在模块级别创建 logger
logger = TestLogger("test_xxx")

# ✅ 正确：在每个测试方法内部创建 logger
def test_p0_page_load(self):
    logger = TestLogger("test_p0_page_load")
    logger.start()
    logger.checkpoint("xxx", True)
    logger.end(success=True)

# ✅ @allure.title() 只写测试方法名
@allure.title("test_p0_page_load")  # ✅
@allure.title("TC-CP-001: xxx")     # ❌
```

## 生成规范

### Page Object 规范

```python
from core.base_page import BasePage
from utils.logger import get_logger

logger = get_logger(__name__)


class XxxPage(BasePage):
    # ═══════════════════════════════════════════════════════════════
    # SELECTORS - 根据 DeepWiki 分析的代码生成
    # ═══════════════════════════════════════════════════════════════
    
    CURRENT_PASSWORD_INPUT = "#currentPassword"
    NEW_PASSWORD_INPUT = "#newPassword"
    CONFIRM_PASSWORD_INPUT = "#confirmPassword"
    SUBMIT_BUTTON = "button[type='submit']"
    
    URL = "/admin/profile/change-password"
    page_loaded_indicator = "#currentPassword"
    
    def navigate(self) -> None:
        logger.info("导航到修改密码页面")
        self.goto(self.URL)
        self.wait_for_page_load()
    
    def is_loaded(self) -> bool:
        return self.is_visible(self.page_loaded_indicator, timeout=5000)
    
    # ═══════════════════════════════════════════════════════════════
    # ACTIONS - 根据功能点生成
    # ═══════════════════════════════════════════════════════════════
    
    def change_password(self, current: str, new: str, confirm: str) -> None:
        """修改密码"""
        self.fill(self.CURRENT_PASSWORD_INPUT, current)
        self.fill(self.NEW_PASSWORD_INPUT, new)
        self.fill(self.CONFIRM_PASSWORD_INPUT, confirm)
        self.click(self.SUBMIT_BUTTON)
```

### Test Case 规范

```python
@allure.feature("修改密码")
class TestChangePassword:
    
    @pytest.mark.P0
    @allure.story("密码修改")
    @allure.title("test_p0_change_password_success")
    @allure.description("""
    **测试目的**: 验证使用正确的当前密码和符合规则的新密码可以成功修改
    
    **前置条件**: 用户已登录
    
    **验证规则** (来自代码分析):
    - 新密码 8-20 字符
    - 必须包含大写、小写、数字
    """)
    def test_p0_change_password_success(self):
        logger = TestLogger("test_p0_change_password_success")
        logger.start()
        # ...
```

## 测试优先级

| 标记 | 含义 | 场景 |
|------|------|------|
| P0 | 核心功能 | 主流程、关键路径 |
| P1 | 重要功能 | 输入验证、边界值 |
| P2 | 一般功能 | UI样式、可访问性 |

## 代码风格

- 中文注释，英文代码
- 使用 ASCII 风格分块注释
- 文件不超过 400 行
- 函数职责单一
