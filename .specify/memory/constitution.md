# Playwright 测试脚手架宪法

## 核心原则

### I. 好品味胜于聪明

**原则**：消除特殊情况而非添加条件逻辑。设计让边界自然融入常规流程的系统。

**规则**：
- 三个或更多分支 → 立即重构。设计消除特殊情况而非添加更多条件。
- 任何函数 > 20 行必须质疑："我是否做错了？"
- 简化是复杂性的最高形式。

**示例**：使用哨兵节点而非头/尾特殊处理。一行代码（`node->prev->next = node->next`）胜过三个分支。

### II. 实用主义胜于完美

**原则**：代码解决真实问题，而非假想的敌人。功能必须可直接测试。

**规则**：
- 始终先编写最简单的工作实现，然后考虑扩展。
- 没有具体需求不做"未来防护"。
- 避免理论完整性陷阱。
- 函数必须简短，只做一件事。
- > 3 层缩进 = 设计错误。

**反模式**：过度工程、过早优化、为抽象而抽象。

### III. 可观察性和证据链（不可协商）

**原则**：每个关键步骤必须留下可审计的证据。失败必须可重现。

**规则**：
- 所有关键操作使用 `allure.step` + 截图（导航、填写、提交、验证）
- 失败证据：页面状态 + 后端响应片段 + 控制台日志
- 测试数据必须可逆（基线 → 修改 → 回滚）
- 日志/截图中不得有敏感数据（密码、令牌、PII）

**强制执行**：没有证据的测试是无效测试。

### IV. 安全作为约束，而非功能

**原则**：安全边界是设计约束，而非附加功能。

**规则**：
- XSS 载荷不得执行（无浏览器对话框）
- SQLi 载荷不得导致 5xx 错误
- 输入验证：前端和后端必须同构
- API 必须用 4xx 拒绝无效数据，即使前端已验证

**测试策略**：安全测试是 P1。无例外。

### V. 简化和文件组织

**原则**：认知负荷是敌人。保持模块小型、专注、可导航。

**规则**：
- 任何语言：每个文件最多 800 行
- 任何文件夹：每层最多 8 个文件（超出则嵌套）
- 函数名：简短、直接、明显
- 复杂性必须被证明、记录和批准

**哲学**："操，这代码真漂亮"是唯一可接受的反应。

## 代码坏味道（需要立即重构）

**僵化性**：小改动触发级联修改
**冗余性**：相同逻辑在多处重复
**循环依赖**：模块无法解耦
**脆弱性**：一处改动破坏无关部分
**晦涩性**：意图不明确，结构混乱
**数据泥团**：相同数据项总是一起出现 → 应该是一个对象

**行动**：识别代码坏味道 → 询问是否优化 → 提供改进计划。无例外。

## 架构文档协议

**触发条件**：任何文件级架构变更（创建/删除/移动文件或文件夹、模块重组、层级调整、职责重新分配）

**行动**：立即更新或在受影响目录中创建 `docs/architecture.md`。无需询问。

**内容**：
- 每个文件的用途和职责用一句话说明
- 目录树结构
- 模块依赖图
- 设计决策的理由

**哲学**：文档滞后 = 技术债务。架构失忆 = 系统崩溃前兆。

## 测试标准

### 页面对象模型（POM）

- **定位器**：稳定选择器（首选 data-testid，CSS/XPath 作为后备）
- **方法**：面向动作（fill_form、click_save、wait_for_success）
- **基类**：继承自 `core/base_page.py` 以获得通用功能
- **无测试逻辑**：POM 提供动作，测试断言结果

### 测试数据管理

- **账户池**：`test-data/test_account_pool.json` 由 fixtures 管理
- **边界数据**：预注册账户用于边缘情况（最小/最大长度、特殊字符、XSS、SQLi）
- **隔离**：测试不得污染共享数据。使用基线-修改-回滚模式。

### 测试优先级

- **P0**：阻塞（登录、导航、关键路径）
- **P1**：高（核心功能、安全）
- **P2**：中（边缘情况、验证）
- **P3**：低（锦上添花、UI 优化）

### 规约驱动测试生成

- **输入**：`specs/###-feature-name/spec.md`（用户故事、AC、风险）
- **计划**：`specs/###-feature-name/plan.md`（实现细节）
- **任务**：`specs/###-feature-name/tasks.md`（执行检查清单）
- **输出**：按功能区域组织的 `tests/`
- **元数据**：`docs/test-plans/` 用于测试元数据和契约

## 技术栈

- **框架**：Playwright（Python）
- **测试运行器**：pytest + pytest-playwright
- **报告**：Allure + pytest-html
- **并行化**：pytest-xdist
- **重试**：pytest-rerunfailures
- **配置**：YAML（config/project.yaml）
- **自动化**：Makefile + scripts/speckit_core.py

## 工作流

### 测试开发

1. **规约**：在 `specs/###-feature-name/spec.md` 中定义功能
2. **计划**：在 `plan.md` 中生成测试计划
3. **任务**：分解为 `tasks.md`
4. **实现**：创建 Page Objects → 编写测试 → 执行 → 报告
5. **验证**：带证据链的 Allure 报告

### 质量门控

- **Linting**：代码必须在提交前通过 linter
- **证据**：关键步骤必须有截图
- **回滚**：数据污染必须清理
- **安全**：XSS/SQLi 测试必须通过

## 治理

**宪法优先于所有其他实践。**

修正需要：
1. 理由文档
2. 影响分析
3. 现有代码的迁移计划
4. 项目维护者批准

**所有代码审查必须验证**：
- 符合好品味原则
- 可观察性要求
- 安全约束
- 文件大小限制
- 无代码坏味道

**版本**：1.0.0 | **批准日期**：2026-01-04 | **最后修正**：2026-01-04
