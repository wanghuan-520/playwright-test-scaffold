# admin_users - 用户管理功能规约

## 0. 核心信息
- **slug**: `admin_users`
- **URL**: `https://localhost:3000/admin/users`
- **页面类型**: LIST
- **是否需要登录态**: 是
- **测试账号**: admin-test01@test.com
- **密码**: Wh520520!

## 1. 用户目标（User Story）

### US-1：查看用户列表（P0）🎯 MVP
**作为** 系统管理员  
**我想要** 查看系统中所有用户的列表  
**以便于** 了解当前用户状况并进行管理

**验收场景**：
- ✅ Given: 管理员已登录
- ✅ When: 访问用户管理页面
- ✅ Then: 显示用户列表（用户名、邮箱、角色、状态）
- ✅ And: 列表加载时间 < 2s

**边缘情况**：
- 空列表状态（无用户时显示提示）
- 大量数据时的分页处理
- 权限不足时的错误提示

### US-2：搜索用户（P0）
**作为** 系统管理员  
**我想要** 通过用户名或邮箱快速搜索用户  
**以便于** 在大量用户中快速定位目标

**验收场景**：
- ✅ Given: 用户列表已加载
- ✅ When: 在搜索框输入关键词
- ✅ Then: 实时过滤显示匹配的用户
- ✅ And: 无结果时显示"未找到用户"提示

**边缘情况**：
- 部分匹配（支持模糊搜索）
- 特殊字符搜索
- 空搜索词显示全部用户

### US-3：创建用户（P1）
**作为** 系统管理员  
**我想要** 创建新用户账号  
**以便于** 为新员工开通系统访问权限

**验收场景**：
- ✅ Given: 管理员在用户管理页面
- ✅ When: 点击"创建用户"按钮
- ✅ Then: 打开创建用户表单
- ✅ And: 填写必填信息（用户名、邮箱、密码）
- ✅ And: 提交后创建成功并显示在列表中

**边缘情况**：
- 用户名已存在（显示错误提示）
- 邮箱已存在（显示错误提示）
- 密码不符合安全策略（前端拦截）
- 邮箱格式不正确（前端验证）
- XSS 注入（用户名、邮箱字段）
- SQLi 注入（搜索功能）

### US-4：编辑用户（P1）
**作为** 系统管理员  
**我想要** 修改现有用户的信息  
**以便于** 更新用户资料或调整权限

**验收场景**：
- ✅ Given: 用户列表中有可编辑的用户
- ✅ When: 点击"编辑"按钮
- ✅ Then: 打开编辑表单，预填充当前信息
- ✅ And: 修改信息并保存成功

**边缘情况**：
- 不允许修改用户名（只读字段）
- 邮箱修改需要验证唯一性
- 角色变更需要二次确认

### US-5：删除用户（P1）
**作为** 系统管理员  
**我想要** 删除不再需要的用户账号  
**以便于** 维护系统安全和账号清洁

**验收场景**：
- ✅ Given: 用户列表中有可删除的用户
- ✅ When: 点击"删除"按钮
- ✅ Then: 显示确认对话框
- ✅ And: 确认后删除成功并从列表移除

**边缘情况**：
- 删除操作需要二次确认
- 不允许删除自己的账号
- 不允许删除超级管理员账号
- 删除失败时显示错误原因

### US-6：角色管理（P2）
**作为** 系统管理员  
**我想要** 为用户分配或移除角色  
**以便于** 控制用户的系统权限

**验收场景**：
- ✅ Given: 用户已创建
- ✅ When: 编辑用户并选择角色
- ✅ Then: 角色分配成功
- ✅ And: 用户获得对应权限

## 2. 范围（In/Out）

**In Scope**：
- ✅ 用户 CRUD 操作（创建、读取、更新、删除）
- ✅ 搜索和过滤功能
- ✅ 基本输入验证（前端 + 后端）
- ✅ 角色分配和管理
- ✅ XSS/SQLi 安全防护验证
- ✅ 未授权访问拦截

**Out of Scope**：
- ❌ 用户批量导入/导出
- ❌ 用户批量操作（批量删除、批量分配角色）
- ❌ 用户详细权限配置（细粒度权限）
- ❌ 用户登录历史记录
- ❌ 用户操作审计日志

## 3. 风险评估

| 风险 | 严重性 | 可能性 | 缓解措施 |
|------|--------|--------|----------|
| 未授权访问用户管理 | 高 | 中 | 验证登录态和管理员权限 |
| XSS 注入攻击 | 高 | 中 | 测试所有输入字段的 XSS 防护 |
| SQLi 注入攻击 | 高 | 低 | 测试搜索功能的 SQLi 防护 |
| 误删除用户数据 | 中 | 中 | 二次确认 + 测试数据回滚 |
| 账号池污染 | 中 | 高 | 测试后清理创建的测试用户 |
| 密码安全策略绕过 | 中 | 低 | 验证前后端密码校验一致性 |

## 4. 验收标准（Acceptance Criteria）

### FR-001：用户列表加载
- ✅ 页面加载时间 < 2s
- ✅ 显示至少：用户名、邮箱、角色、状态
- ✅ 空状态有友好提示
- ✅ 支持分页（每页10/20/50条可选）

### FR-002：搜索功能
- ✅ 支持用户名搜索（模糊匹配）
- ✅ 支持邮箱搜索（模糊匹配）
- ✅ 无结果时显示"未找到用户"
- ✅ 实时搜索（输入即过滤）

### FR-003：创建用户
- ✅ 必填字段验证（用户名、邮箱、密码）
- ✅ 邮箱格式验证（符合 RFC 5322）
- ✅ 密码强度验证（长度、复杂度）
- ✅ 用户名唯一性验证
- ✅ 邮箱唯一性验证
- ✅ 创建成功后显示在列表顶部

### FR-004：编辑用户
- ✅ 表单预填充当前用户信息
- ✅ 用户名字段只读（不可修改）
- ✅ 邮箱修改后验证唯一性
- ✅ 保存成功后更新列表

### FR-005：删除用户
- ✅ 删除前显示确认对话框
- ✅ 确认对话框显示用户名和警告信息
- ✅ 删除成功后从列表移除
- ✅ 不允许删除自己
- ✅ 不允许删除超级管理员

### FR-006：角色管理
- ✅ 支持分配多个角色
- ✅ 角色列表从后端动态获取
- ✅ 角色变更立即生效

### FR-007：安全防护
- ✅ XSS 载荷不执行（用户名、邮箱字段）
- ✅ SQLi 载荷不导致 5xx 错误（搜索功能）
- ✅ 未登录用户被重定向到登录页
- ✅ 非管理员用户无法访问（403 或重定向）

## 5. 数据约束

### 用户名（username）
- 类型：字符串
- 必填：是
- 长度：3-50 字符
- 格式：字母、数字、下划线、连字符
- 唯一性：是

### 邮箱（email）
- 类型：字符串
- 必填：是
- 长度：5-100 字符
- 格式：符合 RFC 5322
- 唯一性：是

### 密码（password）
- 类型：字符串
- 必填：是（创建时）
- 长度：8-100 字符
- 复杂度：至少包含大写、小写、数字、特殊字符中的 3 种
- 存储：加密存储（不可逆）

### 角色（roles）
- 类型：数组
- 必填：否
- 可选值：从后端动态获取

## 6. 成功标准

- ✅ P0 测试 100% 通过（列表加载、搜索）
- ✅ P1 测试 > 95% 通过（CRUD、输入验证）
- ✅ 安全测试全部通过（XSS、SQLi、未授权访问）
- ✅ 关键步骤有截图证据
- ✅ 测试后数据已清理（无污染）

## 7. 测试策略

### P0 测试（关键路径）
- 页面加载
- 列表展示
- 搜索功能

### P1 测试（核心功能）
- 创建用户
- 编辑用户
- 删除用户
- 输入验证（必填、格式、唯一性）

### P2 测试（增强功能）
- 分页
- 排序
- 角色管理
- 批量操作（如果有）

### Security 测试（安全）
- XSS 防护
- SQLi 防护
- 未授权访问拦截

## 8. 回滚策略

- ✅ 测试创建的用户必须在测试结束后删除
- ✅ 使用独特的测试数据标识（test_timestamp_xxx）
- ✅ 如果删除失败，记录到清理日志
- ✅ 定期清理遗留的测试数据

## 9. Repository Mapping

### 前端
- 路由：`/admin/users`
- 组件：`src/pages/admin/users/index.tsx`（推测）
- API 调用：`src/client/sdk.gen.ts`（推测）

### 后端
- 接口：`/api/admin/users`（推测）
- DTO：`UserDto`（推测）
- 约束：参考 Swagger 或 ABP 配置

---

**版本**: 1.0.0  
**创建日期**: 2026-01-05  
**最后更新**: 2026-01-05  
**负责人**: AI Agent (HyperEcho)  
**状态**: ✅ 已完成

