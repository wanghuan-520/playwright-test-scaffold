# UI 自动化测试计划生成规则（Step1：MCP-first）

## 目标（只做 Step1）

输入：**URL + 账号（可选）**  
输出（稳定落盘）：
- 测试计划：`docs/test-plans/<slug>.md`
- 证据链：`docs/test-plans/artifacts/<slug>/{visible.html,visible.txt,page.png,metadata.json}`

> Step2/Step3 不在本规则内：Step2 用 `ui-automation-code-generator.mdc`；Step3 你手动跑 pytest/allure。

## 安全约束（必须）
- **不要把密码写进计划或任何文件**（包括 artifacts/metadata）。
- 若用户给了密码：只用于当次 MCP 登录/页面分析；计划中写“密码通过环境变量/账号池提供”。
- **允许在 Playwright MCP 的浏览器会话中输入密码完成当次登录**（仅用于获取页面证据/结构；不得落盘到 repo）。
- **不要把 Token/Cookie/storageState 落盘到 repo**：证据链只允许 UI 可见信息与规则快照（JSON），禁止保存鉴权凭证。

## 账号来源（必须写清楚）
- Step1 计划里允许写明“测试账号 email”（用于可读性），但 **Step2 自动化执行默认必须使用账号池**（不得把该账号/密码写死到测试代码里）。

## 配置真理源（必须）

- 所有“环境地址/账号池路径/仓库路径”必须来自：`config/project.yaml`
  - `environments.<env>.frontend.url` / `environments.<env>.backend.url`
  - `test_data.accounts.path`
  - 仓库本地路径优先级：
    - `repositories.*.local_path`（若非空）
    - `service_startup.*.cwd`
- 本规则只做 Step1 文档与证据链；**不要修改账号池内容**（账号池由 fixture 在执行期管理）。

## 需求对齐（必须）
- 生成测试计划必须对齐项目需求：`docs/requirements/requirements.md`
  - Aevatar：**输入校验以 ABP 后端为真理源**

## 规则补全（必须）
- 校验/边界/一致性：对齐 `.cursor/rules/quality/test-case-standards.mdc`
- 仅凭证据链无法确定阈值/策略：在计划里标注 `TBD(代码推导)`，禁止硬猜

## 执行步骤（MCP-first）

### 1) 页面解析与证据链（必须先做证据）
优先使用 **Cursor Playwright MCP**（编辑器侧）完成：
- 导航到 URL → 等待页面稳定
- 判断是否需要登录态（若跳转登录/403/未授权提示，则标记“需要登录态”并提示用户提供账号）
- 导出：可见 HTML / 可见文本 / 截图

落盘要求（必须）：
- `visible.txt` 必须包含：页面标题、核心控件摘要（input/button/tab 等）、是否疑似需要登录态
- `metadata.json` 必须包含：slug/url/title/元素映射（role+name 优先）/证据文件名列表

如果 MCP 无法使用（例如用户拒绝浏览器权限 / 无法打开 localhost）：
- 输出失败原因
- 请求用户提供：storageState/cookie 或 MCP 导出的 PageInfo/HTML/截图（桥接模式）

### 1.2) 规则快照（条件触发：ABP/Swagger 优先；否则走代码识别/计划降级）

> 目的：当项目**确实存在可获取的后端规则**时，优先把规则“落盘为证据”，避免阈值凭空猜测；  
> 但**不是所有项目都是 ABP**，因此本步骤必须是“条件触发”，而不是全局硬前提。

#### 触发条件（满足任一即可执行快照采集）
- 需求明确：`docs/requirements/requirements.md` 指定“输入校验以 ABP 后端为真理源”
- 运行时探测：`GET <frontend_base>/api/abp/application-configuration` 返回 200（或返回 JSON 且包含 `settings.values`）
- 运行时探测：存在可访问 OpenAPI/Swagger（例如 `GET <backend_base>/swagger/v1/swagger.json` 返回 200）

#### 若触发：采集并落盘（推荐，但仅在触发时要求）
- `docs/test-plans/artifacts/<slug>/abp_app_config.json`
  - 来源：`GET <frontend_base>/api/abp/application-configuration`
  - 用途：提取 **PasswordPolicy**（RequiredLength / RequireDigit / RequireUppercase / RequireLowercase / RequireNonAlphanumeric / RequiredUniqueChars 等）
- `docs/test-plans/artifacts/<slug>/abp_swagger.json`
  - 来源（择一可用）：
    - `GET <backend_base>/swagger/v1/swagger.json`
    - `GET <frontend_base>/swagger/v1/swagger.json`
  - 用途：提取 DTO 约束（required/minLength/maxLength/pattern），作为输入校验矩阵的“真理源”
- `docs/test-plans/artifacts/<slug>/backend_swagger.json`（强烈建议：更权威、更少重定向问题）
  - 来源：`GET <backend_base>/swagger/v1/swagger.json`
  - 说明：前端域名下的 swagger 可能被租户/登录流程重定向；优先抓后端直连
- `docs/test-plans/artifacts/<slug>/abp_rules_extract.json`
  - 内容：从上述 JSON 解析出的“规则摘要”（仅结构化规则，不包含任何用户输入/密码）

#### 若不触发 / 采集失败：降级策略（必须写进计划，避免硬猜）
- **优先降级到“代码识别”**（仅当仓库可读时）：
  - 后端：搜索 DTO/校验（minLength/maxLength/regex/required；或 ABP 的 PasswordOptions/IdentityOptions）
  - 前端：搜索表单校验（schema/validator/regex/提示文案来源）
  - 将推导出的规则以“推导证据 + 文件路径/片段”写入计划（仍需脱敏，禁止包含密码）
- 若代码也无法识别：在计划中标注 `TBD(无法获得真理源：快照失败 + 代码不可读)`，并说明原因（401/403/404/网络/权限）。
- **禁止硬猜阈值**：没有快照/代码证据就不写死 requiredLength/maxLength/regex。

### 1.3) 前后端代码识别（条件触发：非 ABP / 规则不足以补全用例时）

> 目的：当项目不是 ABP（或无法抓取规则快照），但“补全用例”又需要更可靠的约束来源时，  
> 通过识别前后端代码，抽取**可证据化**的输入限制/业务校验/错误体结构，减少 TBD。

#### 仓库位置来源（强制：单一真相源）

补充用例/规则时，**必须优先参考前后端代码**，且代码仓库位置必须从本仓库的配置读取：

- 真理源：`config/project.yaml`
- 前端/后端本地路径优先级（从高到低）：
  - `repositories.frontend.local_path` / `repositories.backend.local_path`（若非空）
  - `service_startup.frontend.cwd` / `service_startup.backend.cwd`（用于本地启动的工作目录）
- 若上述路径不存在/不可读：
  - 记录原因（路径为空/目录不存在/权限不足）
  - 按 1.2 的降级策略在计划中保留 `TBD(代码识别失败)`，**禁止硬猜阈值**

触发条件（满足任一即可执行）：
- 1.2 未触发（项目非 ABP / 无 swagger / 无法访问后端规则）
- 计划中的关键阈值/规则仍为 `TBD`，且会影响 P1 矩阵/边界用例的可运行性
- 页面证据链不足以解释校验来源（例如：提示文案来自后端错误体、或前端 schema）

执行要求（仅在仓库可读时启用；否则跳过并记录原因）：
- **后端侧**（优先契约/权威）：
  - 搜索与该页面相关的 DTO / Request Model / Controller / Endpoint（含 route）
  - 提取：required/min/max/regex/enum/range、自定义业务校验、错误码/错误体字段
- **前端侧**（可观测行为）：
  - 搜索该路由页面组件 + 表单 schema/validator + 提交 API client
  - 提取：前端拦截逻辑（disabled/inline error/提交前校验）、错误展示绑定点（aria/role/文案来源）
  - **必须提取接口契约**：请求方法 + URL path + 请求体字段（以及可能的状态码/错误体类型）
  - 推荐证据源（常见于本项目）：`src/client/sdk.gen.ts` / `src/client/types.gen.ts`（OpenAPI 生成的“契约镜像”）

落盘产物（必须脱敏，禁止包含任何密码/凭证/Token）：
- `docs/test-plans/artifacts/<slug>/code_rules_extract.json`
  - 内容：规则摘要（字段约束、接口契约、错误体结构、可观测 UI 映射）
  - 证据：每条规则必须附带 `evidence`（文件路径 + symbol/片段摘要），不要把整段源码复制进 JSON

失败策略：
- 若仓库不可读/无法定位相关代码：在计划中记录原因，并保留 `TBD(代码识别失败)`；禁止硬猜阈值。

### 2) 生成测试计划（必须可执行）
计划必须包含：
- 页面概述（风险点 + 优先级依据）
- 元素映射（定位器优先级：role/label/testid > aria > 语义 CSS > 结构 CSS）
- 用例设计（P0 主链路 + P1 校验矩阵 + security 最小集）
- 数据设计（JSON：valid/invalid/boundary + policy_matrix（可 TBD））
- 自动化建议（对齐本仓库：`core/base_page.py`、`auth_page`、账号池回滚）
- 建议目录（对齐 Step2）：`tests/<module>/<domain>/<page>/`（每个页面一个文件夹）

## 输出要求（硬规则）
- 必须写到：`docs/test-plans/<slug>.md`
- 必须同步写出证据链目录：`docs/test-plans/artifacts/<slug>/`