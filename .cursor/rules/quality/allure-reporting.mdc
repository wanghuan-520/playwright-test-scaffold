# 📸 Allure 报告增强规范

## 必须使用 Allure 功能

1. **@allure.feature()** - 功能模块
2. **@allure.story()** - 功能故事
3. **@allure.title()** - 测试用例标题（可选：仅在“非参数化、标题更清晰”时使用）
4. **@allure.description()** - 测试描述（目的、前置条件、步骤）
5. **allure.step()** - 关键步骤（必须包含截图）
6. **take_screenshot()** - 截图功能（自动附加到 Allure）

> 说明（关键）：本仓库以 `tests/admin/profile/profile_settings` 的报告风格为标杆：  
> **少标题噪音、少参数噪音、多证据截图、多 step 结构。**

## 截图要求

**所有关键步骤必须添加截图：**
- ✅ 页面导航后
- ✅ 填写表单后
- ✅ 点击按钮后
- ✅ 验证操作后
- ✅ 错误验证后
- ✅ 成功验证后

**截图范围策略（强制）**

- 默认：**视口截图**（更快，通常足够覆盖输入区 + toast 区）
- 需要全页审计/复杂布局时：使用环境变量开启全页截图：`FULL_PAGE_SHOT=1`

> 原则：证据可检证优先，但不要为“全页”牺牲 4 worker 并发稳定性。


---

## Toast/动态消息截图规范（强制）

Toast 是 UI 副作用，**网络响应 OK ≠ toast 已渲染**。因此必须：

1) **成功步骤截图**：必须等成功提示出现后再截图（避免截图没抓到 Success）。  
2) **步骤间清理**：进入下一步前必须等待上一条 toast 消失（避免“错误 toast + 成功 toast 同框污染”）。  
3) **可读性兜底**：当提示挤在输入框附近、全页截图看不清时，除 full-page 外，再补一张“输入框局部截图”（高亮边框/元素截图）。

推荐模式（示意）：

```python
# 1) 触发保存并等待网络响应（更可靠）
resp = page_obj.save_and_wait_profile_update()
assert resp.ok

# 2) 再等待成功提示出现（避免截图漏 toast）
page_obj.wait_for_save_success()
page_obj.take_screenshot("step_after_save_success", full_page=True)

# 3) 下一步前清理 toast（避免同框）
page_obj.wait_for_toasts_to_disappear()
```

---

## 截图命名规范

- 使用有意义的名称：`step_navigate`, `step_fill_form`, `step_click_save`
- 避免重复：每个测试用例中的截图名称应该唯一
- 使用下划线分隔：`step_verify_error` 而不是 `stepVerifyError`

---



## 🔇 报告降噪（强制，老兵口味）

目标：Allure 只展示“前端可检证证据”，不要被基础设施过程淹没。

### 0) 用例命名/参数化降噪（强制，可判定）

#### 0.1 定义：什么叫“标题污染（title pollution）”

当 Allure 的 test name/title 中出现以下任一类内容，定义为“污染”，必须修正：

- **环境参数**：`chromium` / `firefox` / `webkit` 等被当作独立标题片段重复展示，且不增加阅读价值
- **实现细节**：selector（如 `role=textbox[...]`）、URL、API path、正则、locator 表达式
- **大输入**：payload、长字符串（> 32 chars）、长列表/字典（dict/list 直接 stringify）
- **不可读噪音**：引号/括号混杂、截断乱码（通常来自 parametrize 的 repr）

> 判断标准：读者不看代码，只看 Allure 也能理解“测什么/证据在哪”。如果标题里全是实现细节，就是污染。

#### 0.2 规则：参数化（pytest.mark.parametrize）的标题约束

**允许进入标题的参数（只允许这 3 类）**：

- `case_name`：短小、稳定、ASCII（例如 `email_invalid_format`）
- `role`/`persona`：最多 12 chars（例如 `admin`/`unauth`）
- `priority`：P0/P1/P2（可选）

**禁止进入标题的参数（必须转附件/截图）**：

- selector / payload / patch / request body / response body / 任意 dict/list
- 任意长度 > 32 的字符串

**落地做法**：

- 参数化必须包含 `case_name`，并把其它信息用 `allure.attach(..., TEXT)` 或截图留证
- 参数化 test 的 Allure title/name 应近似：`<what> [<case_name>]`，不出现实现细节

#### 0.3 选择策略：何时用 parametrize，何时用“单 test + step 场景循环”

两种写法都允许，但触发条件必须明确：

- **用 parametrize（推荐用于少量场景）**：
  - 场景数 ≤ 8
  - 且每个场景的“可展示参数”只有 `case_name`（无 selector/payload/dict 入标题）

- **必须改为单 test + step 循环（推荐用于矩阵/注入/大 payload）**：
  - 场景数 > 8，或
  - 场景参数包含 payload/patch/selector，或
  - 你无法保证 Allure 标题不会出现污染内容

单 test + step 循环的规范：

- Allure 里只出现一个 test（suite 更干净）
- 每个场景用 `with allure.step(f"[{case_name}] ..."):` 展开
- payload/patch 必须 `allure.attach(..., TEXT)`（不要进标题）
- 每场景默认只保留 1~2 张关键截图：`step_<case>_filled` / `step_<case>_result`
- **场景之间必须可自愈**：如果场景会导航/刷新/改变页面结构，下一个场景开始前必须确保回到目标页面（必要时重新 navigate）

#### 0.3.1 场景失败要“标红到 step”，但不能中断后续场景（强制）

适用：矩阵/边界/注入类用例（单 test + step 循环），你希望：

- **每个失败场景**在 Allure 中对应的 step 直接显示 **FAILED/BROKEN**
- 但用例仍要继续执行后续场景（一次运行看全貌）
- 最终用例整体仍要 **FAILED**（产品缺陷不能被吞掉）

**强制做法**：

- **必须在 `with allure.step(...)` 内抛出异常**，让该 step 标红
- **必须在 step 外 `try/except` 捕获**，记录失败并 `continue`，不打断循环
- 循环结束后，如有失败，**统一 raise** 汇总错误（保证 test 失败）

推荐模板（直接复制）：

```python
failures: list[str] = []

for case_name, scenario in scenarios:
    # ... (必要时做自愈导航/重置页面状态)

    # 1) 动作 step
    with allure.step(f"[{case_name}] act"):
        # fill/click + 关键截图
        step_shot(po, f"step_{case_name}_act", full_page=True)

    # 2) 断言 step（失败需标红到 step）
    try:
        with allure.step(f"[{case_name}] assert"):
            # 失败时在此处直接 raise / assert False
            assert condition, "reason"
    except AssertionError as e:
        # 重要：捕获在 step 外，避免中断后续场景
        failures.append(f"[{case_name}] {e}")
        continue

if failures:
    raise AssertionError("scenario failures:\\n" + "\\n".join(failures))
```

**禁止**：

- 在 step 外直接 `assert` / `raise` 导致整条 test 提前中断（看不到后续场景）
- 只在最后汇总 fail，但不在场景 step 内抛异常（Allure 里看不到“哪个场景/哪个 step”标红）

#### 0.4 @allure.title 的使用规则（强制）

- **参数化测试**：默认 **不写 `@allure.title`**（容易触发 `'chromium'` 等参数噪音）
- **非参数化测试**：允许写 `@allure.title`，但必须满足：
  - 不包含可变值（timestamp / random / 用户名 / email）
  - 不包含 selector/payload/dict
  - 长度 ≤ 40

#### 0.5 Checklist（生成/重构必须过）

- 标题是否只包含“人能读懂”的信息（无 selector/payload/dict）？
- 是否每条用例都有 2~4 个关键 step（navigate / act / result）？
- 每个 step 是否有截图证据（或明确说明为何不需要）？
- 若是矩阵/注入：是否把场景展开到 step，而不是污染标题？

### 1) 不展示的内容（默认）

- baseline 修正过程
- teardown 回滚过程
- 纯断言步骤（assert-only steps）
- 后端接口/回滚诊断的长文本

### 2) 通过开关按需打开（默认关闭）

- `ALLURE_SHOW_BACKEND=1`：展示后端/回滚诊断附件（默认不展示）
- `ALLURE_SHOW_META=1`：展示规则来源/规则快照等元信息（默认不展示）
- `ALLURE_SHOW_DEBUG=1`：展示 debug 截图/提示（例如 baseline/teardown 截图）

> 实现建议：区分 `step_shot()`（证据截图，默认展示）与 `debug_shot()`（debug 截图，仅在 ALLURE_SHOW_DEBUG=1 展示）。

### 3) Description 必须写清测试点

每条 case 必须有 `@allure.description()`：用 5~10 行把“测试点/证据/回滚策略”说明白。

## ✅ Allure 闭环质量门槛（强制）

> 目标：Allure 报告不仅“好看”，更要“可诊断”。失败必须带证据，否则等同于没报错。

### 1) 报告卫生（必须）

- 每次运行前默认必须清理旧的：`allure-results/`、`allure-report/`、`screenshots/`
- 仅当需要趋势图时允许保留 `allure-results/history/`（通过 `KEEP_ALLURE_HISTORY=1`）

### 2) 失败附件标准（必须）

任意失败用例，在 Allure 中必须至少看到：

- **failure_screenshot**（PNG）
- **console**（TEXT）
- **requestfailed**（TEXT）
- **playwright_trace**（ZIP，适用于 `auth_page` 路径）

缺失任意一项，视为“不可诊断失败”，必须先补采集链路，再讨论业务断言。

### 3) Suites 层级（必须）

- 生成的测试用例默认使用**函数式**（不生成 `class Test*`）
- 目标：Allure Suites 目录结构压扁，避免出现冗余第三层 class 维度