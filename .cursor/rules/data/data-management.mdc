# ğŸ“Š æµ‹è¯•æ•°æ®ç®¡ç†è§„èŒƒ

## âš ï¸ æ ¸å¿ƒåŸåˆ™

- **è´¦å·æ± æ˜¯å…±äº«èµ„æºï¼Œä½†å¹¶å‘æ—¶å¿…é¡»äº’æ–¥**ï¼šå…è®¸â€œä¸åŒç”¨ä¾‹å¤ç”¨åŒä¸€è´¦å·ï¼ˆä¸²è¡Œï¼‰â€ï¼Œç¦æ­¢â€œå¤šä¸ª worker åŒæ—¶ä½¿ç”¨åŒä¸€è´¦å·â€ã€‚
- **è·‘å‰é¢„æ£€ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰**ï¼šå¹¶å‘è·‘å‰å¿…é¡»ç”¨åç«¯æ¥å£é¢„æ£€è´¦å·å¯ç™»å½•ã€è§’è‰²/æƒé™ï¼Œé¿å… setup é˜¶æ®µç›²æ’ã€‚
- **å†™æ“ä½œå¿…é¡»å¯å›æ»š**ï¼šUI ç”¨ä¾‹ç»“æŸä¸å…è®¸æ±¡æŸ“è´¦å·èµ„æ–™ï¼ˆfixture teardown å…œåº•ï¼Œä¸”åªåœ¨çœŸçš„å†™æˆåŠŸè¿‡æ‰å›æ»šä¿å­˜ï¼‰ã€‚

### âœ… æ¨èåšæ³•ï¼ˆæœ¬é¡¹ç›®æœ€ä½³å®è·µï¼‰

- å¹¶å‘è·‘å‰ï¼š

```bash
PRECHECK_ACCOUNTS=1 REUSE_LOGIN=1 make test TEST_TARGET=tests/admin/profile PYTEST_ARGS="-n 4"
```

- è´¦å·æ± å¤±æ•ˆ/éœ€è¦é‡å»ºï¼šä½¿ç”¨åç«¯æ³¨å†Œæ¥å£æ‰¹é‡ç”Ÿæˆï¼ˆæ¸…ç©ºæ—§æ± å¹¶å¤‡ä»½ï¼‰ã€‚

> åŸåˆ™ï¼šè®©å¤±è´¥å‘ç”Ÿåœ¨â€œè·‘å‰é¢„æ£€â€ï¼Œä¸è¦å‘ç”Ÿåœ¨â€œsetup é˜¶æ®µå…¨çº¢â€ã€‚


## ğŸ” ç™»å½•æ€å¤ç”¨ï¼ˆå¼ºçƒˆæ¨èï¼‰

å½“ç”¨ä¾‹æ•°é‡è¾ƒå¤šï¼ˆå°¤å…¶ P1/P2/securityï¼‰æ—¶ï¼Œåå¤èµ° OIDCâ†’ABP `/Account/Login` å®¹æ˜“è§¦å‘åç«¯ **lockout**ã€‚

**æ¨èåšæ³•**ï¼šä½¿ç”¨ session çº§ç™»å½•æ€ç¼“å­˜ï¼ˆPlaywright `storage_state`ï¼‰
- âœ… session çº§å…ˆç™»å½•ä¸€æ¬¡å¹¶å¯¼å‡º `.auth/storage_state.json`
- âœ… åç»­ç”¨ä¾‹ä½¿ç”¨ `auth_page` fixture å¤ç”¨ç™»å½•æ€ï¼ˆæ¯æ¡ç”¨ä¾‹ä»æ˜¯ç‹¬ç«‹ contextï¼Œé¿å…äº’ç›¸æ±¡æŸ“ï¼‰

**ç¦æ­¢åšæ³•**ï¼ˆå¤§ç”¨ä¾‹é›†æ—¶ï¼‰
- âŒ æ¯æ¡ç”¨ä¾‹éƒ½è°ƒç”¨ `_login(page, test_account)`ï¼ˆä¼šå¯¼è‡´ lockout/å¤§é‡ skipï¼‰


**1. æ•°æ®åˆ†ç¦» - æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•æ•°æ®**
- æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹**å°½é‡**ä½¿ç”¨ç‹¬ç«‹çš„æµ‹è¯•è´¦å·ï¼ˆè´¦å·æ± ä¸è¶³æ—¶å…è®¸ä¸²è¡Œå¤ç”¨ï¼Œä½†å¿…é¡»ä¿è¯ä¸å¹¶å‘å¤ç”¨ï¼‰
- ç¦æ­¢å¤šä¸ª **å¹¶å‘ worker** å…±äº«åŒä¸€ä¸ªæµ‹è¯•è´¦å·ï¼ˆä¸²è¡Œå¤ç”¨å…è®¸ï¼Œå¹¶å‘å¤ç”¨ç¦æ­¢ï¼‰
- ä½¿ç”¨ `test_account` fixture è‡ªåŠ¨åˆ†é…è´¦å·

**2. æ•°æ®æ¸…æ´— - æµ‹è¯•å‰åè‡ªåŠ¨æ¸…ç†æ•°æ®çŠ¶æ€**
- æµ‹è¯•å‰: è‡ªåŠ¨è§£é”è´¦å·ã€é‡ç½®çŠ¶æ€
- æµ‹è¯•å: è‡ªåŠ¨é‡Šæ”¾è´¦å·ã€æ¢å¤çŠ¶æ€
- ç¡®ä¿æµ‹è¯•ä¹‹é—´ä¸ä¼šç›¸äº’å½±å“

## âœ… æ­£ç¡®å®ç°æ–¹å¼ï¼ˆæ¨èï¼šå¤ç”¨ç™»å½•æ€ + ç‹¬ç«‹ contextï¼‰

```python
import pytest


@pytest.mark.P0
def test_p0_change_password_success(auth_page):
    """
    P0: æ­£å¸¸ä¿®æ”¹å¯†ç 

    å…³é”®ç‚¹ï¼š
    - ç”¨ `auth_page`ï¼ˆfixture ä¼šå¤ç”¨ session çº§ storage_stateï¼Œé¿å…æ¯æ¡ç”¨ä¾‹éƒ½é‡æ–°ç™»å½•å¯¼è‡´ lockoutï¼‰
    - ä¸è¦åœ¨ç”¨ä¾‹é‡Œæ‰‹å†™ `_login()` + `wait_for_timeout()`ï¼ˆå®¹æ˜“ flakyï¼‰
    """
    page = auth_page
    # ...æµ‹è¯•é€»è¾‘ï¼ˆä½¿ç”¨ç”Ÿæˆçš„ Page Objectï¼‰
```

## âŒ å¸¸è§é”™è¯¯

**1. ç¡¬ç¼–ç æµ‹è¯•è´¦å·**
```python
# âŒ é”™è¯¯ï¼šç¡¬ç¼–ç è´¦å·
def test_xxx(self, page):
    account = {"username": "testuser", "password": "Test123456!"}

# âœ… æ­£ç¡®ï¼šä½¿ç”¨test_account fixture
def test_xxx(self, page, test_account):
    self._login(page, test_account)
```

**2. ç¼ºå°‘test_accountå‚æ•°**
```python
# âŒ é”™è¯¯ï¼šæ²¡æœ‰ä½¿ç”¨test_account fixture
def test_xxx(self, page):
    self._login(page)

# âœ… æ­£ç¡®ï¼šå¿…é¡»æ·»åŠ test_accountå‚æ•°
def test_xxx(self, page, test_account):
    self._login(page, test_account)
```

## ğŸ“‹ æ•°æ®æ¸…æ´—æµç¨‹

**æµ‹è¯•å‰ï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰:**
1. è§£é”è´¦å·ï¼ˆå¦‚æœè¢«é”å®šï¼‰
2. é‡ç½®è´¦å·çŠ¶æ€ï¼ˆ`in_use=False`ï¼‰
3. æ¸…é™¤é”å®šåŸå› 
4. åˆ†é…è´¦å·ç»™æµ‹è¯•ç”¨ä¾‹ï¼ˆ`in_use=True`ï¼‰

**æµ‹è¯•åï¼ˆè‡ªåŠ¨æ‰§è¡Œï¼‰:**
1. é‡Šæ”¾è´¦å·ï¼ˆ`in_use=False`ï¼‰
2. æ¢å¤è´¦å·å¯†ç åˆ°åˆå§‹å€¼ï¼ˆå¦‚æœè¢«ä¿®æ”¹ï¼‰
3. æ¸…é™¤æ‰€æœ‰çŠ¶æ€æ ‡è®°
4. æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
5. **ç¡®ä¿è´¦å·å®Œå…¨æ¢å¤åˆ°åˆå§‹çŠ¶æ€**
